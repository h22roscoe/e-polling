<?xml version="1.0"?>
<project name="e-polling-project" default="tests" basedir="." xmlns:ivy="antlib:org.apache.ivy.ant"> 
  <property name="main.build.dir" value="build/main" />
  <property name="main.src.dir" value="src" />
  <property name="tests.build.dir" value="build/tests" />
  <property name="tests.src.dir" value="tests" />
 
  <path id="ivy.lib.path">
      <fileset dir="lib" includes="*.jar"/>
      </path>
      <taskdef resource="org/apache/ivy/ant/antlib.xml"
               uri="antlib:org.apache.ivy.ant" classpathref="ivy.lib.path"/>
  
  <path id="classpath.base" />

  <!-- adding junit to the classpath for testing on travis -->
  <path id="classpath.test">
    <!-- get the junit stuff from ivy -->
    <pathelement location="lib/junit-4.12.jar" />
    <pathelement location="lib/hamcrest-core-1.3.jar" />
    <pathelement location="${main.build.dir}" />
    <path refid="classpath.base" />
  </path>

  <target name="tests" depends="run, clean" />

  <target name="resolve" description="retrieve dependencies with ivy">
    <ivy:retrieve />
  </target>

  <!-- only compile the project -->
  <target name="compile" depends="resolve">
    <mkdir dir="${main.build.dir}" />
    <javac srcdir="${main.src.dir}" destdir="${main.build.dir}" includeantruntime="false">
      <classpath refid="classpath.base" />
    </javac>
  </target>

  <!-- only build the project -->
  <target name="build" depends="compile">
    <mkdir dir="${tests.build.dir}" />
    <javac srcdir="${tests.src.dir}" destdir="${tests.build.dir}" includeantruntime="false">
      <classpath refid="classpath.test" />
    </javac>
    <echo message="Epolling Build Complete" />
  </target>
  
  <!-- build and run the tests -->
  <target name="run" depends="build">
    <junit printsummary="on" haltonfailure="yes" fork="true">
      <classpath>
        <path refid="classpath.test" />
        <pathelement location="${tests.build.dir}" />
      </classpath>
      <formatter type="brief" usefile="false" />
      <batchtest>
        <fileset dir="${tests.src.dir}" includes="**/*Test.java" />
      </batchtest>
    </junit>
  </target>
  
  <!-- clean the build directory -->
  <target name="clean">
    <delete>
      <fileset dir="${basedir}" includes="**/*.class" />
    </delete>
    <echo message="Clean Finished" />
  </target>
</project>
